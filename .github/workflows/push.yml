name: Push on main
on:
  push:
    branches: [ main ]
jobs:
  push:
    runs-on: ubuntu-latest
    environment: Development
    steps:

      - name: Checkout code
        uses: actions/checkout@v2

      - name: Package YAML files
        run: |
          mkdir artifacts
          cp src/main/1Link/*.yaml artifacts/
          zip -r my_project_artifact.zip artifacts
          echo "Artifact created: my_project_artifact.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: my_project_artifact
          path: my_project_artifact.zip

      - name: List YAML files and set environment variable
        run: |
          SPEC_FILES=""
          for file in $(find artifacts -type f -name "*.yaml"); do
            filename=$(basename "artifact/$file")
            SPEC_FILES="$SPEC_FILES${filename//_/-}:true,"
          done
          echo "SPEC_FILES=${SPEC_FILES%,}" >> $GITHUB_ENV

      - name: Import YAML files into Microcks
        uses: microcks/import-github-action@v1
        with:
          specificationFiles: ${{ env.SPEC_FILES }}
          microcksURL: 'https://microcks.dbank.engineering/api/'
          keycloakClientId:  'microcks-serviceaccount'
          keycloakClientSecret:  'ab54d329-e435-41ae-a900-ec6b3fe15c54'
